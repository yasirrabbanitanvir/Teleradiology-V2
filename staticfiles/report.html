<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <title>Medical Report</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Calibri', Arial, Helvetica, sans-serif;
      background: #f5f5f5;
      color: #000000;
      overflow: hidden;
    }
    .top-bar {
      background: white;
      border-bottom: 1px solid #ddd;
      padding: 12px 20px;
    }
    .patient-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
    }
    .patient-info span {
      color: #000000;
    }
    .patient-info strong {
      color: #000000;
      margin-left: 5px;
    }
    .controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .template-controls {
      display: none;
      gap: 10px;
      align-items: center;
    }
    .template-controls.visible {
      display: flex;
    }
    .controls-row label {
      font-size: 14px;
      font-weight: 500;
      color: #000000;
    }
    .controls-row select {
      padding: 6px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 3px;
      background: white;
      min-width: 150px;
      color: #000000;
    }
    .right-controls {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .submit-btn {
      background: #0066cc;
      color: white;
      border: none;
      padding: 7px 18px;
      cursor: pointer;
      border-radius: 3px;
      font-size: 14px;
      font-weight: 500;
    }
    .submit-btn:hover {
      background: #0052a3;
    }
    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status-msg {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 3px;
      display: none;
    }
    .status-msg.success {
      display: inline-block;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-msg.error {
      display: inline-block;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .main-container {
      display: flex;
      height: calc(100vh - 95px);
      background: #f5f5f5;
    }
    .sidebar {
      width: 250px;
      background: white;
      border-right: 1px solid #ddd;
      padding: 15px;
      overflow-y: auto;
    }
    .sidebar h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #000000;
      font-weight: 600;
    }
    .sidebar select {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
      color: #000000;
    }
    .content-area {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow: auto;
    }
    .page-wrapper {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 320mm;
      min-height: 297mm;
      transform-origin: top center;
    }
    .page-content {
      padding: 0.4in 0.7in;
    }
    .header-title {
      text-align: center;
      font-size: 18.5px;
      font-weight: bold;
      margin-bottom: 8px;
      color: #000000;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #000000;
      padding-bottom: 6px;
    }
    .patient-table {
      width: 100%;
      border: 2px solid #000000;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 18.5px;
      line-height: 1.3;
    }
    .patient-table tr {
      border: 1px solid #000000;
    }
    .patient-table td {
      padding: 6px 10px;
      color: #000000;
      border: 1px solid #000000;
      vertical-align: middle;
      font-size: 18.5px;
      line-height: 1.3;
    }
    .patient-table strong {
      font-size: 18.5px;
    }
    .label-col {
      font-weight: 700;
      width: 120px;
      color: #000000;
      font-size: 18.5px;
    }
    .colon-col {
      font-weight: 700;
      width: 25px;
      text-align: center;
      color: #000000;
      font-size: 18.5px;
    }
    .value-col {
      color: #000000;
      font-size: 18.5px;
    }

    #editor {
      background: white;
      font-family: 'Calibri', Arial, sans-serif;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      min-height: 540px;
    }
    .ql-toolbar {
      background: #fafafa;
      border: 1px solid #ddd !important;
      border-bottom: none !important;
    }
    .ql-container {
      border: 1px solid #ddd !important;
      font-family: 'Calibri', Arial, sans-serif;
      font-size: 18.5px;
    }
    .ql-editor {
      font-size: 18.5px;
      line-height: 1.6;
      font-family: 'Calibri', Arial, sans-serif;
      padding: 16px;
      min-height: 400px;
      color: #000000;
    }
    .ql-editor p,
    .ql-editor strong,
    .ql-editor span,
    .ql-editor li {
      color: #000000 !important;
      font-size: 18.5px !important;
    }
    .ql-editor ul,
    .ql-editor ol {
      font-size: 18.5px !important;
    }
    .doctor-signature {
      margin-top: 25px;
      text-align: left;
    }
    .sig-img {
      margin-bottom: 3px;
    }
    .sig-img img {
      max-width: 120px;
      max-height: 50px;
      display: block;
    }
    .signature-line {
      margin: 1px 0;
      font-size: 18px;
      line-height: 1.2;
      color: #000000;
    }
    .doctor-name {
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 1px;
      color: #000000;
    }
    @media (max-width: 1400px) {
      .sidebar {
        display: none;
      }
      .template-controls {
        display: flex !important;
      }
    }
    @media print {
      body { background: white; }
      .top-bar, .sidebar { display: none; }
      .content-area { padding: 0; }
      .page-wrapper { box-shadow: none; transform: none !important; }
      .ql-toolbar { display: none; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="patient-info">
      <div><span>Patient:</span><strong id="hPatientName">-</strong></div>
      <div><span>ID:</span><strong id="hPatientId">-</strong></div>
      <div><span>Age:</span><strong id="hPatientAge">-</strong></div>
      <div><span>Sex:</span><strong id="hPatientSex">-</strong></div>
    </div>
    <div class="controls-row">
      <div class="template-controls" id="navbarTemplates">
        <label>Body Part:</label>
        <select id="navBodyPart">
          <option value="">All</option>
        </select>
        <label>Template:</label>
        <select id="navTemplate">
          <option value="">Select</option>
        </select>
      </div>
      <div class="right-controls">
        <label>Status:</label>
        <select id="statusSelect">
          <option value="Draft">Draft</option>
          <option value="Reviewed">Reviewed</option>
          <option value="Reported" selected>Reported</option>
        </select>
        <button class="submit-btn" id="submitBtn">Submit Report</button>
        <div class="status-msg" id="statusMsg"></div>
      </div>
    </div>
  </div>
  <div class="main-container">
    <div class="sidebar" id="sidebar">
      <h3>Body Part</h3>
      <select id="bodyPartSelect">
        <option value="">All Body Parts</option>
      </select>
      <h3>Template</h3>
      <select id="templateSelect" size="6" style="height: auto;">
        <option value="">Select Template</option>
      </select>
    </div>
    <div class="content-area">
      <div class="page-wrapper" id="pageWrapper">
        <div class="page-content">
          <div class="header-title">DEPARTMENT OF RADIOLOGY AND IMAGING</div>
          <table class="patient-table">
            <tr>
              <td class="label-col"><strong>Name</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tName">-</td>
              <td class="label-col"><strong>Patient ID</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tId">-</td>
            </tr>
            <tr>
              <td class="label-col"><strong>Age</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tAge">-</td>
              <td class="label-col"><strong>Exam date</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tExamDate">-</td>
            </tr>
            <tr>
              <td class="label-col"><strong>Sex</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tSex">-</td>
              <td class="label-col"><strong>Report date/Time</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" id="tReportDateTime">-</td>
            </tr>
            <tr>
              <td class="label-col"><strong>Refd By</strong></td>
              <td class="colon-col"><strong>:</strong></td>
              <td class="value-col" colspan="4" id="tDoctor">-</td>
            </tr>
          </table>
          <div id="templateHeading" contenteditable="true" style="display: none; text-align: center; font-weight: bold; font-size: 19px; margin: 12px 0 8px 0; text-decoration: underline; color: #000000; outline: none;"></div>
          <div id="editor"></div>
          <div class="doctor-signature">
            <div class="sig-img" id="sigImg"></div>
            <div class="signature-line doctor-name" id="sigName"></div>
            <div class="signature-line" id="sigQual"></div>
            <div class="signature-line" id="sigDesig"></div>
            <div class="signature-line" id="sigInst"></div>
            <div class="signature-line" id="sigBMDC"></div>
            <div class="signature-line" id="sigMobile"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let quill;
    let patientData = {};
    let currentPatientId = null;
    let doctorInfo = null;
    let allTemplates = {};
    let userPermissions = {
      can_write_reports: false,
      can_manage_templates: false
    };
    const baseUrl = window.location.origin;
    const token = localStorage.getItem('token');
    
    function checkScreenSize() {
      const navTemplates = document.getElementById('navbarTemplates');
      if (window.innerWidth <= 1400) {
        navTemplates.classList.add('visible');
      } else {
        navTemplates.classList.remove('visible');
      }
    }
    
    function scalePaper() {
      const paper = document.getElementById('pageWrapper');
      const viewArea = document.querySelector('.content-area');
      const availHeight = viewArea.clientHeight - 40;
      const paperHeight = 297 * 3.7795275591;
      const scale = Math.min(availHeight / paperHeight, 0.95);
      paper.style.transform = `scale(${scale})`;
    }
    
    window.addEventListener('resize', () => {
      checkScreenSize();
      scalePaper();
    });
    
    window.addEventListener('load', () => {
      checkScreenSize();
      scalePaper();
    });
    
    async function checkAccess() {
      if (!token) return false;
      try {
        const res = await fetch(`${baseUrl}/api/current-user/`, {
          headers: {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) return false;
        const data = await res.json();
        if (!data.success) return false;
        
        if (data.permissions) {
          userPermissions = data.permissions;
        }
        
        if (!userPermissions.can_write_reports) {
          showMsg('You do not have permission to write reports', 'error');
          setTimeout(() => {
            window.close();
          }, 2000);
          return false;
        }
        
        doctorInfo = data;
        updateSignature(data);
        return true;
      } catch (err) {
        console.error('Access error:', err);
        return false;
      }
    }
    
    function updateSignature(doc) {
      const name = doc.full_name || doc.doctor_name || '';
      const qual = doc.qualification || '';
      const desig = doc.designation || '';
      const inst = doc.institute_name || doc.center_name || '';
      const bmdc = doc.bmdc_reg_no || '';
      const mobile = doc.contact_number || doc.mobile || doc.phone || '';
      const sigUrl = doc.signature || '';
      document.getElementById('sigName').textContent = name;
      document.getElementById('sigQual').textContent = qual;
      document.getElementById('sigDesig').textContent = desig;
      document.getElementById('sigInst').textContent = inst;
      document.getElementById('sigBMDC').textContent = bmdc ? `BMDC Reg No: ${bmdc}` : '';
      document.getElementById('sigMobile').textContent = mobile ? `Mobile: ${mobile}` : '';
      const sigImgDiv = document.getElementById('sigImg');
      if (sigUrl) {
        const fullUrl = sigUrl.startsWith('http') ? sigUrl : `${baseUrl}${sigUrl}`;
        sigImgDiv.innerHTML = `<img src="${fullUrl}" alt="Signature" onerror="console.error('Signature load failed'); this.style.display='none';">`;
      }
    }
    
    function initQuill() {
      quill = new Quill('#editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['clean']
          ]
        },
        placeholder: 'Start typing your report here or select a template...'
      });
      quill.setText('');
      setTimeout(() => quill.focus(), 200);
    }
    
    async function loadTemplates() {
      try {
        const res = await fetch(`${baseUrl}/api/report-templates/`, {
          headers: {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) return;
        const data = await res.json();
        if (data.success && data.grouped) {
          allTemplates = data.grouped;
          populateBodyParts(data.grouped);
          populateTemplates(data.grouped);
        }
      } catch (err) {
        console.error('Template error:', err);
      }
    }
    
    function populateBodyParts(grouped) {
      const parts = Object.keys(grouped).sort();
      [document.getElementById('bodyPartSelect'), document.getElementById('navBodyPart')].forEach(select => {
        select.innerHTML = '<option value="">All Body Parts</option>';
        parts.forEach(bp => {
          const opt = document.createElement('option');
          opt.value = bp;
          opt.textContent = bp;
          select.appendChild(opt);
        });
      });
    }
    
    function populateTemplates(grouped, filterBP = '') {
      const parts = filterBP ? [filterBP] : Object.keys(grouped).sort();
      [document.getElementById('templateSelect'), document.getElementById('navTemplate')].forEach(select => {
        const isSidebar = select.id === 'templateSelect';
        select.innerHTML = '<option value="">Select Template</option>';
        parts.forEach(bp => {
          if (!grouped[bp]) return;
          grouped[bp].forEach(tmpl => {
            const opt = document.createElement('option');
            opt.value = tmpl.id;
            opt.textContent = isSidebar ? `${bp} - ${tmpl.template_name}` : tmpl.template_name;
            opt.dataset.content = tmpl.content;
            opt.dataset.bodypart = tmpl.body_part;
            opt.dataset.templatename = tmpl.template_name;
            select.appendChild(opt);
          });
        });
      });
    }
    
    let currentTemplateName = "";
    function handleTemplateChange(selectEl) {
      const opt = selectEl.options[selectEl.selectedIndex];
      if (opt.value && opt.dataset.content) {
        quill.root.innerHTML = opt.dataset.content;
        currentTemplateName = opt.dataset.templatename || opt.textContent || "";
        const headingEl = document.getElementById('templateHeading');
        if (currentTemplateName && currentTemplateName.trim()) {
          headingEl.textContent = currentTemplateName;
          headingEl.style.display = 'block';
        } else {
          headingEl.style.display = 'none';
        }
        if (opt.dataset.bodypart) {
          document.getElementById('bodyPartSelect').value = opt.dataset.bodypart;
          document.getElementById('navBodyPart').value = opt.dataset.bodypart;
        }
        setTimeout(() => quill.focus(), 100);
      }
    }
    
    document.getElementById('bodyPartSelect').addEventListener('change', function() {
      populateTemplates(allTemplates, this.value);
      document.getElementById('navBodyPart').value = this.value;
    });
    
    document.getElementById('navBodyPart').addEventListener('change', function() {
      populateTemplates(allTemplates, this.value);
      document.getElementById('bodyPartSelect').value = this.value;
    });
    
    document.getElementById('templateSelect').addEventListener('change', function() {
      handleTemplateChange(this);
      document.getElementById('navTemplate').value = this.value;
    });
    
    document.getElementById('navTemplate').addEventListener('change', function() {
      handleTemplateChange(this);
      document.getElementById('templateSelect').value = this.value;
    });
    
    function updatePatientInfo(data) {
      const name = data.patientName || 'Unknown';
      const id = data.patientId || 'N/A';
      const age = (data.patientAge && parseInt(data.patientAge) !== 0) ? data.patientAge : 'N/A';
      const sex = (data.patientGender || 'U').toString().charAt(0).toUpperCase();
      const doctor = (data.referringPhysician && data.referringPhysician.trim() !== '') ? data.referringPhysician : 'N/A';
      const now = new Date();
      
  
      let examDate;
      if (data.examDate && data.examDate.trim() !== '') {
        
        const parts = data.examDate.split('/');
        if (parts.length === 3) {
          examDate = `${parts[1]}-${parts[0]}-${parts[2]}`;
        } else {
          examDate = data.examDate;
        }
      } else {
    
        examDate = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
      }
      
      const reportDateTime = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
      
      document.getElementById('hPatientName').textContent = name;
      document.getElementById('hPatientId').textContent = id;
      document.getElementById('hPatientAge').textContent = age;
      document.getElementById('hPatientSex').textContent = sex;
      document.getElementById('tName').textContent = name;
      document.getElementById('tId').textContent = id;
      document.getElementById('tAge').textContent = age + 'Y';
      document.getElementById('tSex').textContent = sex;
      document.getElementById('tExamDate').textContent = examDate;
      document.getElementById('tReportDateTime').textContent = reportDateTime;
      document.getElementById('tDoctor').textContent = doctor;
    }
    
    let currentViewerLink = "";
    function handleData(data) {
      patientData = data;
      if (data.dicomImageId) {
        currentPatientId = parseInt(data.dicomImageId) || data.dicomImageId;
      } else if (data.patientId) {
        currentPatientId = parseInt(data.patientId) || data.patientId;
      }
      console.log('Current Patient ID:', currentPatientId);
      
      if (data.viewer_link) {
        currentViewerLink = data.viewer_link;
      }
      updatePatientInfo(data);
    }
    
    function showMsg(msg, type) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = `status-msg ${type}`;
      setTimeout(() => {
        el.className = 'status-msg';
      }, 5000);
    }
    
    async function generateDoc() {
      const name = document.getElementById('tName').textContent;
      const id = document.getElementById('tId').textContent;
      const ageSex = document.getElementById('tAgeSex').textContent;
      const dt = document.getElementById('tExam').textContent;
      const doc = document.getElementById('tDoctor').textContent;
      const report = quill.root.innerHTML;
      
      const headingEl = document.getElementById('templateHeading');
      const finalTemplateName = headingEl.style.display !== 'none' && headingEl.textContent.trim() ? headingEl.textContent.trim() : '';
      
      const dName = doctorInfo.full_name || '';
      const dDesig = doctorInfo.designation || '';
      const dQual = doctorInfo.qualification || '';
      const dInst = doctorInfo.institute_name || '';
      const dBMDC = doctorInfo.bmdc_reg_no ? `BMDC Reg No: ${doctorInfo.bmdc_reg_no}` : '';
      const dMobile = doctorInfo.mobile || '';
      const dSig = doctorInfo.signature || '';
      let sigTag = '';
      if (dSig) {
        const fullUrl = dSig.startsWith('http') ? dSig : `${baseUrl}${dSig}`;
        sigTag = `<div class="sig-img"><img src="${fullUrl}" style="max-width: 120px; max-height: 50px;"></div>`;
      }
      const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    @page { size: A4; margin: 0.5in 0.6in; }
    body { font-family: Calibri, Arial, sans-serif; font-size: 14px; line-height: 1.5; margin: 0; color: #000000; }
    .title { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 8px; letter-spacing: 0.5px; border-bottom: 2px solid #000000; padding-bottom: 4px; color: #000000; }
    .patient-table { 
      width: 100%; 
      border: 2px solid #000000;
      border-collapse: collapse;
      margin: 10px 0; 
      font-size: 13px; 
    }
    .patient-table tr { 
      border: 1px solid #000000;
    }
    .patient-table td { 
      padding: 6px 10px; 
      color: #000000; 
      border: 1px solid #000000;
      vertical-align: middle;
    }
    .label-col { 
      font-weight: 700; 
      width: 120px; 
      background-color: #d9d9d9;
      color: #000000;
    }
    .value-col { 
      color: #000000;
      background-color: #ffffff;
    }
    .section { font-weight: bold; text-decoration: underline; margin: 10px 0 6px 0; font-size: 15px; color: #000000; }
    .content { font-size: 14px; line-height: 1.5; color: #000000; }
    .content p, .content strong, .content span, .content li { color: #000000 !important; }
    .signature { margin-top: 25px; page-break-inside: avoid; }
    .signature div { margin: 1px 0; font-size: 13px; line-height: 1.2; color: #000000; }
    .sig-name { font-weight: bold; font-size: 14px; color: #000000; }
    .sig-img { margin-bottom: 3px; }
    .sig-img img { max-width: 120px; max-height: 50px; }
    p { margin: 3px 0; color: #000000; }
    strong { font-weight: bold; color: #000000; }
    ul, ol { margin: 3px 0; padding-left: 20px; }
    img { display: block; }
  </style>
</head>
<body>
  <div class="title">DEPARTMENT OF RADIOLOGY AND IMAGING</div>
  <table class="patient-table" border="2" cellpadding="6" cellspacing="0" bordercolor="#000000">
    <tbody>
    <tr>
      <td class="label-col"><b>Name :</b></td>
      <td class="value-col">${name}</td>
    </tr>
    <tr>
      <td class="label-col"><b>Patient ID :</b></td>
      <td class="value-col">${id}</td>
    </tr>
    <tr>
      <td class="label-col"><b>Age / Sex :</b></td>
      <td class="value-col">${ageSex}</td>
    </tr>
    <tr>
      <td class="label-col"><b>Ref by :</b></td>
      <td class="value-col">${doc}</td>
    </tr>
    <tr>
      <td class="label-col"><b>Exam Date/Time :</b></td>
      <td class="value-col">${dt}</td>
    </tr>
    </tbody>
  </table>
  ${finalTemplateName && finalTemplateName.trim() ? `<div style="text-align: center; font-weight: bold; font-size: 15px; margin: 12px 0 8px 0; text-decoration: underline; color: #000000;">${finalTemplateName}</div>` : ''}
  <div class="section">Examination Procedure (Sonogram)</div>
  <div class="content">${report}</div>
  <div class="signature">
    ${sigTag}
    <div class="sig-name">${dName}</div>
    <div>${dQual}</div>
    <div>${dDesig}</div>
    <div>${dInst}</div>
    <div>${dBMDC}</div>
    ${dMobile ? `<div>Mobile: ${dMobile}</div>` : ''}
  </div>
</body>
</html>`;
      const blob = new Blob([html], { type: 'application/msword' });
      const ts = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '');
      const filename = `Report_${currentPatientId}_${ts}.doc`;
      return { blob, filename };
    }
    
    document.getElementById('submitBtn').addEventListener('click', async function() {
      const btn = this;
      const stat = document.getElementById('statusSelect').value;
      if (!token) {
        showMsg('Authentication required', 'error');
        return;
      }
      
      if (!userPermissions.can_write_reports) {
        showMsg('You do not have permission to write reports', 'error');
        return;
      }
      
      if (!currentPatientId) {
        showMsg('Patient ID not found', 'error');
        console.error('No patient ID available');
        return;
      }
      const reportText = quill.getText().trim();
      const reportHTML = quill.root.innerHTML.trim();
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = reportHTML;
      const actualText = tempDiv.textContent.trim();
      if (!actualText || actualText.length < 5) {
        showMsg('Please enter report content', 'error');
        return;
      }
      try {
        btn.disabled = true;
        showMsg('Generating...', 'success');
        
        const headingEl = document.getElementById('templateHeading');
        const finalTemplateName = headingEl.style.display !== 'none' && headingEl.textContent.trim() ? headingEl.textContent.trim() : '';
        
        console.log("Template name:", finalTemplateName);
        console.log("Viewer link:", currentViewerLink);
        
        const now = new Date();
        const reportSubmissionDateTime = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        const displayedExamDate = document.getElementById('tExamDate').textContent;
        const examDateTime = `${displayedExamDate} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        const docxRes = await fetch(`${baseUrl}/api/generate-report-docx/`, {
          method: 'POST',
          headers: {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            patient_data: patientData,
            report_content: reportHTML,
            doctor_info: doctorInfo,
            patient_id: currentPatientId,
            exam_date: examDateTime,
            viewer_link: currentViewerLink,
            template_name: finalTemplateName,
            report_submission_datetime: reportSubmissionDateTime
          })
        });
        
        if (!docxRes.ok) {
          throw new Error('DOCX generation failed');
        }
        
        const docxBlob = await docxRes.blob();
        const ts = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '');
        const filename = `Report_${currentPatientId}_${ts}.docx`;
        
        const fd = new FormData();
        fd.append('file', docxBlob, filename);
        
        console.log('Uploading report to:', `${baseUrl}/api/dicom-images/${currentPatientId}/upload_report/`);
        const upRes = await fetch(`${baseUrl}/api/dicom-images/${currentPatientId}/upload_report/`, {
          method: 'POST',
          headers: { 'Authorization': `Token ${token}` },
          body: fd
        });
        
        if (!upRes.ok) {
          const errText = await upRes.text();
          console.error('Upload failed:', upRes.status, errText);
          throw new Error(`Upload failed: ${upRes.status}`);
        }
        
        const uploadData = await upRes.json();
        console.log('Upload response:', uploadData);
        
        console.log('Updating status to:', stat);
        const stRes = await fetch(`${baseUrl}/api/dicom-images/${currentPatientId}/update_status/`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: stat,
            reported_by: doctorInfo.full_name || '',
            report_content: reportHTML
          })
        });
        
        if (!stRes.ok) {
          const errText = await stRes.text();
          console.error('Status update failed:', stRes.status, errText);
          throw new Error(`Status update failed: ${stRes.status}`);
        }
        
        const statusData = await stRes.json();
        console.log('Status update response:', statusData);
        
        showMsg('Report saved successfully', 'success');
        
        try {
          const payload = {
            type: 'reportSaved',
            dicomImageId: currentPatientId || null,
            studyUID: (patientData && (patientData.studyId || patientData.dicomImageId)) || null
          };
          if (window.opener && !window.opener.closed) {
            try { window.opener.postMessage(payload, window.location.origin); } catch (e) {}
          }
          if (window.opener && window.opener.opener && !window.opener.opener.closed) {
            try { window.opener.opener.postMessage({ type: 'refreshDoctor', dicomImageId: payload.dicomImageId, studyUID: payload.studyUID }, window.location.origin); } catch (e) {}
          }
        } catch (e) {}
        
        setTimeout(() => {
          try { window.close(); } catch (e) {}
        }, 300);
      } catch (err) {
        console.error('Submit error:', err);
        showMsg(`Error: ${err.message}`, 'error');
        btn.disabled = false;
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn && !submitBtn.disabled) {
          submitBtn.click();
        }
      }
    });
    
    (function() {
      const sugg = document.createElement('div');
      sugg.id = 'templateSuggestionBox';
      sugg.style.position = 'absolute';
      sugg.style.zIndex = 9999;
      sugg.style.minWidth = '220px';
      sugg.style.maxWidth = '520px';
      sugg.style.background = '#fff';
      sugg.style.border = '1px solid #ccc';
      sugg.style.boxShadow = '0 2px 6px rgba(0,0,0,0.12)';
      sugg.style.borderRadius = '4px';
      sugg.style.display = 'none';
      sugg.style.maxHeight = '220px';
      sugg.style.overflowY = 'auto';
      sugg.style.fontFamily = 'Calibri, Arial, sans-serif';
      sugg.style.fontSize = '15px';
      sugg.style.padding = '4px 0';
      document.body.appendChild(sugg);
      const style = document.createElement('style');
      style.innerHTML = `
        #templateSuggestionBox .ti { padding: 6px 10px; cursor: pointer; }
        #templateSuggestionBox .ti:hover, #templateSuggestionBox .ti.active { background: #f0f8ff; }
        #templateSuggestionBox .sub { color: #666; font-size: 13px; margin-left: 8px; }
      `;
      document.head.appendChild(style);
      let flattenedTemplates = [];
      function flattenAllTemplates() {
        flattenedTemplates = [];
        Object.keys(allTemplates || {}).forEach(bp => {
          (allTemplates[bp] || []).forEach(t => {
            flattenedTemplates.push(Object.assign({}, t, { body_part: bp }));
          });
        });
      }
      const origLoadTemplates = loadTemplates;
      loadTemplates = async function() {
        await origLoadTemplates();
        flattenAllTemplates();
      };
      if (Object.keys(allTemplates || {}).length) flattenAllTemplates();
      let currentIndex = -1;
      function showSuggestions(items, coords) {
        if (!items || items.length === 0) {
          hideSuggestions();
          return;
        }
        sugg.innerHTML = '';
        items.slice(0, 20).forEach((it, i) => {
          const div = document.createElement('div');
          div.className = 'ti';
          div.dataset.index = i;
          div.innerHTML = `<strong>${escapeHtml(it.template_name)}</strong><span class="sub">${escapeHtml(it.body_part || '')}</span>`;
          div.addEventListener('mousedown', (ev) => {
            ev.preventDefault();
            selectSuggestion(it);
          });
          sugg.appendChild(div);
        });
        const editorBounds = document.querySelector('#editor .ql-editor') || document.getElementById('editor');
        if (coords) {
          sugg.style.left = coords.left + 'px';
          sugg.style.top = (coords.top + coords.height + 4) + 'px';
        } else if (editorBounds) {
          const rect = editorBounds.getBoundingClientRect();
          sugg.style.left = (rect.left + 10) + 'px';
          sugg.style.top = (rect.bottom + 6) + 'px';
        }
        sugg.style.display = 'block';
        currentIndex = -1;
        updateActiveItem();
      }
      function updateActiveItem() {
        Array.from(sugg.querySelectorAll('.ti')).forEach(el => el.classList.remove('active'));
        if (currentIndex >= 0) {
          const el = sugg.querySelector(`.ti[data-index="${currentIndex}"]`);
          if (el) {
            el.classList.add('active');
            const r = el.getBoundingClientRect();
            const s = sugg.getBoundingClientRect();
            if (r.bottom > s.bottom) el.scrollIntoView(false);
            if (r.top < s.top) el.scrollIntoView();
          }
        }
      }
      function hideSuggestions() {
        sugg.style.display = 'none';
        currentIndex = -1;
      }
      function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }
      async function selectSuggestion(template) {
        if (!quill || !template) return;
        const range = quill.getSelection(true);
        if (!range) return hideSuggestions();
        const maxLookback = 200;
        const cursor = range.index;
        const startIdx = Math.max(0, cursor - maxLookback);
        const context = quill.getText(startIdx, cursor - startIdx);
        const m = context.match(/(\S+)$/);
        const tokenStart = m ? (cursor - m[1].length) : cursor;
        quill.deleteText(tokenStart, cursor - tokenStart, 'user');
        quill.clipboard.dangerouslyPasteHTML(tokenStart, template.content || template.template_name || '', 'user');
        
        currentTemplateName = template.template_name || '';
        const headingEl = document.getElementById('templateHeading');
        if (currentTemplateName && currentTemplateName.trim()) {
          headingEl.textContent = currentTemplateName;
          headingEl.style.display = 'block';
        } else {
          headingEl.style.display = 'none';
        }
        
        setTimeout(() => {
          quill.setSelection(tokenStart + 1, 0);
          hideSuggestions();
          quill.focus();
        }, 30);
      }
      function setupTextListener() {
        quill.on('text-change', (delta, oldDelta, source) => {
          if (source !== 'user') return;
          try {
            const range = quill.getSelection();
            if (!range) { hideSuggestions(); return; }
            const maxLen = 100;
            const start = Math.max(0, range.index - maxLen);
            const text = quill.getText(start, range.index - start);
            const m = text.match(/(\S+)$/);
            const lastWord = m ? m[1] : '';
            if (!lastWord || lastWord.trim().length === 0) {
              hideSuggestions();
              return;
            }
            const q = lastWord.trim().toLowerCase();
            if (!flattenedTemplates || flattenedTemplates.length === 0) flattenAllTemplates();
            const matches = flattenedTemplates.filter(t => {
              const name = (t.template_name || '').toLowerCase();
              const content = (t.content || '').replace(/<[^>]*>/g,' ').toLowerCase();
              return (name.startsWith(q) || content.trim().startsWith(q));
            }).map(t => ({ template_name: t.template_name, content: t.content, body_part: t.body_part, id: t.id }));
            if (matches.length === 0) {
              hideSuggestions();
              return;
            }
            let coords;
            try {
              const bounds = quill.getBounds(range.index);
              const editorRect = document.querySelector('#editor .ql-editor').getBoundingClientRect();
              coords = {
                left: editorRect.left + bounds.left,
                top: editorRect.top + bounds.top,
                height: bounds.height
              };
            } catch (e) {
              coords = null;
            }
            showSuggestions(matches, coords);
          } catch (err) {
            console.error('Suggestion error:', err);
            hideSuggestions();
          }
        });
        document.addEventListener('keydown', function(ev) {
          if (sugg.style.display === 'none') return;
          const items = sugg.querySelectorAll('.ti');
          if (!items || items.length === 0) return;
          if (ev.key === 'ArrowDown') {
            ev.preventDefault();
            ev.stopPropagation();
            currentIndex = (currentIndex + 1) % items.length;
            updateActiveItem();
          } else if (ev.key === 'ArrowUp') {
            ev.preventDefault();
            ev.stopPropagation();
            currentIndex = currentIndex <= 0 ? items.length - 1 : currentIndex - 1;
            updateActiveItem();
          } else if (ev.key === 'Enter' || ev.key === 'Tab') {
            if (currentIndex >= 0 || items.length === 1) {
              ev.preventDefault();
              ev.stopPropagation();
              const idx = currentIndex >= 0 ? currentIndex : 0;
              const itemEl = sugg.querySelector(`.ti[data-index="${idx}"]`);
              if (itemEl) {
                const allItems = flattenedTemplates.filter(t => {
                  const name = (t.template_name || '').toLowerCase();
                  const content = (t.content || '').replace(/<[^>]*>/g,' ').toLowerCase();
                  const range = quill.getSelection();
                  if (!range) return false;
                  const maxLen = 100;
                  const start = Math.max(0, range.index - maxLen);
                  const text = quill.getText(start, range.index - start);
                  const m = text.match(/(\S+)$/);
                  const lastWord = m ? m[1] : '';
                  const q = lastWord.trim().toLowerCase();
                  return (name.startsWith(q) || content.trim().startsWith(q));
                });
                if (allItems[idx]) {
                  selectSuggestion(allItems[idx]);
                }
              }
            }
          } else if (ev.key === 'Escape') {
            ev.preventDefault();
            hideSuggestions();
            quill.focus();
          }
        }, true);
        document.addEventListener('mousedown', function(e) {
          if (!sugg.contains(e.target)) hideSuggestions();
        });
      }
      if (typeof quill !== 'undefined') {
        setupTextListener();
      } else {
        const qCheck = setInterval(() => {
          if (typeof quill !== 'undefined') {
            clearInterval(qCheck);
            setupTextListener();
          }
        }, 150);
      }
    })();
    
    document.addEventListener('DOMContentLoaded', async function() {
      const access = await checkAccess();
      if (access) {
        initQuill();
        await loadTemplates();
        setTimeout(() => {
          checkScreenSize();
          scalePaper();
        }, 100);
        window.addEventListener('message', (e) => {
          if (e.data?.type === 'patientData' && e.data?.data) {
            handleData(e.data.data);
          }
        });
        setTimeout(() => {
          try {
            const saved = sessionStorage.getItem('patientDataForReport');
            if (saved) {
              const data = JSON.parse(saved);
              if (data && Object.keys(data).length > 0) {
                handleData(data);
              }
            }
          } catch (e) {
            console.error('Session error:', e);
          }
        }, 500);
      } else {
        showMsg('Access denied', 'error');
      }
    });
  </script>
</body>
</html>
